<!DOCTYPE html>
<head>
    
    <!-- <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Allura|Raleway"/>
    <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css"/>
    <link rel="stylesheet" type="text/css" href="./styles/main.css"/>
    

    <link rel="alternate" type="application/atom+xml" title="Blog" href="/atom.xml" /> -->
    <meta charset="utf-8">
    <link rel="stylesheet" href="./styles/d3.slider.css" />
<style>

svg{
  background: white;
}

.country{
  fill: #cccccc;
  stroke: #333333;
  stroke-width: 0.5;
}

.selected{
  fill: orange;
}

.site {
	opacity: 0.5;
  fill: red;
}

#slider3{
  width: 1000px;
}

#tooltip {
  text-align: left;
  padding: 16px;
  background-color: lightsalmon;
  border: 1px solid black;
  width: auto;
  opacity: 0;
  color: black;
  position: absolute;
}


</style>
</head>
<div id='map'></div>
<div id="tooltip">
  Province/State: <span id="p_s" class="info"></span><br> 
  Country/Region: <span id="c_r" class="info"></span><br>
  Date: <span id="date" class="info"></span><br>  
  Accumulated Confirmed: <span id="confirmed" class="info"></span><br>  
  Accumulated Deaths: <span id="deaths" class="info"></span><br> 
  Accumulated Recovered: <span id="recovered" class="info"></span><br> 
</div>
<div id="slider3"></div>
<body>
<script src="https://d3js.org/d3.v3.min.js"></script>
<script src="https://d3js.org/d3-queue.v3.min.js"></script>
<script src="https://d3js.org/d3-geo.v1.min.js"></script>
<script src="https://d3js.org/topojson.v1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.3/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
<script src="./styles/d3.slider.js"></script>
<script>
// Copies a variable number of methods from source to target.
d3.rebind = function(target, source) {
  var i = 1, n = arguments.length, method;
  while (++i < n) target[method = arguments[i]] = d3_rebind(target, source, source[method]);
  return target;
};

// Method is assumed to be a standard D3 getter-setter:
// If passed with no arguments, gets the value.
// If passed with arguments, sets the value and returns the target.
function d3_rebind(target, source, method) {
  return function() {
    var value = method.apply(source, arguments);
    return value === source ? target : value;
  };
}

var margin = {top: 50, right: 50, bottom: 50, left: 50},
    width = 1000 - margin.left - margin.right,s
    height = 400 - margin.top - margin.bottom;


var svg = d3.select("#map").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)

    

svg.append('rect')
    .attr('width', width )
    .attr('height', height )
    .attr('fill', 'white');

var g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

d3.queue()
  .defer(d3.json,"world.topojson")
  .await(ready);

var projection = d3.geo.equirectangular();

var path = d3.geoPath()
  .projection(projection);


function ready(error, data){
    console.log(data);
    var countries = topojson.feature(data, data.objects.countries).features;

    g.selectAll('.country')
      .data(countries)
      .enter().append('path')
      .attr('class','country')
      .attr('d', path)
      .on('click', function(d){
        d3.select(this).classed('selected',!this.classList.contains("selected")) //if directly change 'fill', it will be overwritten by css
      })
    
    var zoom = d3.behavior.zoom()
      .on('zoom',function(){
        g.attr('transform','translate(' + 
          d3.event.translate.join(',') + ')scale(' + d3.event.scale + ')');
        g.selectAll('path')
          .attr('d',path.projection(projection));
    });
    svg.call(zoom);
    
    d3.csv("./data/covid_19_clean_complete.csv")
    .row(function(d) {
      return {
        "Province/State":d["Province/State"],
        "Country/Region":d["Country/Region"],
        lat: parseFloat(d.Lat),
        lng: parseFloat(d.Long),
        date: moment(d.Date,"MM/DD/YYYY").unix(),
        number: parseFloat(d.Confirmed),
        deaths: d.Deaths,
        recovered: d.Recovered
      };
    })
    .get(function(err, rows) {
    	if (err) return console.error(err);

      window.site_data = rows;
    });

    
}



var displaySites = function(data) {
  var sites = g.selectAll(".site")
      .data(data, function(d) {
        return d.number;
      });
  
  sites.enter().append("circle")
      .attr("class", "site")
      .attr("cx", function(d) {
        return projection([d.lng, d.lat])[0];
      })
      .attr("cy", function(d) {
        return projection([d.lng, d.lat])[1];
      })
      .attr("r", function(d) {
        // console.log(d.number);
        return 0;
      })
      .transition().duration(400)
      .attr("r", function(d) {
        // console.log(d.number);
        return Math.sqrt(d.number) / 10;
      });
      
    sites.on('mouseover', function(d) {
          d3.select(this).style('opacity', '1'); 
          d3.select('#p_s').text(d["Province/State"]);
          d3.select('#c_r').text(d["Country/Region"]);
          d3.select('#date').text(timeConverter(d.date));
          d3.select('#confirmed').text(d.number);
          d3.select('#deaths').text(d.deaths);
          d3.select('#recovered').text(d.recovered);
          d3.select('#tooltip')
            .style('left', (d3.event.pageX + 20) + 'px')
            .style('top', (d3.event.pageY - 80) + 'px')
            .style('display', 'block')
            .style('opacity', 0.8)
        });
        //Add Event Listeners | mouseout
      sites.on('mouseout', function(d) { 
          d3.select(this).style('opacity', '0.5');
          d3.select('#tooltip')
            .style('display', 'none');
        });
      

 sites.exit()
    .transition().duration(200)
    .attr("r", function(d) {
        return Math.sqrt(d.number) / 10;
      })
      .remove();
};

var minDateUnix = moment('1/22/20', "MM/DD/YYYY").unix();
var maxDateUnix = moment('3/23/20', "MM/DD/YYYY").unix();
var secondsInDay = 60 * 60 * 24;

function timeConverter(UNIX_timestamp){
        var a = new Date(UNIX_timestamp * 1000);
        var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        var year = a.getFullYear();
        var month = months[a.getMonth()];
        var date = a.getDate();
        var time = date + ' ' + month + ' ' + year ;
        return time;
}

function sameDate(x,y){
    var a =  new Date(x*1000);
    var b =  new Date(y*1000);
    return (a.getDate() == b.getDate()) && (a.getMonth() == b.getMonth());
}

d3.select('#slider3').call(d3.slider()
  .axis(true).min(minDateUnix).max(maxDateUnix).step(secondsInDay)
  .on("slide", function(evt, value) {
    // console.log('y:'+timeConverter(value));
    var newData = _(site_data).filter( function(site) {
      return sameDate(site.date, value);
    })
    newData.sort(function (a, b){
      return d3.descending(a.number,b.number);
    })
    // console.log("New set size ", newData.length);

    displaySites(newData);
  })
);

</script>